# Flutteré‹å‹•è³½äº‹ç®¡ç†æ‡‰ç”¨ - Firebaseèˆ‡SQLiteæ•¸æ“šå„²å­˜å•é¡Œåˆ†æ

## å•é¡Œç¸½çµ
ä½¿ç”¨è€…é¢è‡¨çš„ä¸»è¦å•é¡Œæ˜¯æ¯”è³½å¾Œçš„é …ç›®å’Œå¹´é½¡è¨­å®šç„¡æ³•æ­£ç¢ºå„²å­˜ï¼Œç³»çµ±ç¸½æ˜¯ä½¿ç”¨é è¨­å€¼è€Œéç”¨æˆ¶è¨­å®šçš„å€¼ã€‚

## åŸå› åˆ†æ

### 1. Firebaseèˆ‡SQLiteæ•¸æ“šçµæ§‹ä¸åŒ¹é…
é€šéåˆ†æä»£ç¢¼ï¼Œæˆ‘ç™¼ç¾å¹´é½¡åˆ†çµ„å’Œæ¯”è³½é …ç›®åœ¨CompetitionModelä¸­è¢«å®šç¾©ç‚ºåµŒå¥—çµæ§‹ï¼š
- `events`: å„²å­˜ç‚º`List<Map<String, dynamic>>`
- `metadata.age_groups`: å„²å­˜ç‚º`List<Map<String, dynamic>>`

ç„¶è€Œï¼Œåœ¨SQLiteæ•¸æ“šè¡¨(`competitions`)ä¸­ï¼Œåªæœ‰åŸºæœ¬æ¬„ä½ï¼š
```sql
CREATE TABLE IF NOT EXISTS competitions (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT NOT NULL,
  venue TEXT,
  start_date TEXT NOT NULL,
  end_date TEXT NOT NULL,
  status TEXT NOT NULL,
  created_by TEXT NOT NULL,
  created_at TEXT NOT NULL
)
```

é€™è¡¨ç¤ºSQLiteæ²’æœ‰å„²å­˜è¤‡é›œçš„åµŒå¥—çµæ§‹å¦‚eventså’Œage_groupsã€‚

### 2. æ•¸æ“šè½‰æ›å•é¡Œ
åœ¨`CompetitionManager.getAllCompetitions()`æ–¹æ³•ä¸­ï¼Œå¾SQLiteè®€å–è³‡æ–™æ™‚é€²è¡Œçš„è½‰æ›ä¸å®Œæ•´ï¼š
```dart
final modelData = {
  'id': maps[i]['id'],
  'name': maps[i]['name'],
  'description': maps[i]['description'],
  'venue': maps[i]['venue'],
  'startDate': maps[i]['start_date'],
  'endDate': maps[i]['end_date'],
  'status': maps[i]['status'],
  'createdBy': maps[i]['created_by'],
  'createdAt': maps[i]['created_at'],
};
```
é€™è£¡æ²’æœ‰åŒ…å«eventså’Œmetadataæ¬„ä½ï¼Œå°è‡´å¾SQLiteæ¢å¾©çš„æ•¸æ“šç¼ºå°‘é€™äº›é—œéµä¿¡æ¯ã€‚

### 3. æ•¸æ“šå„²å­˜ä¸å®Œæ•´
åœ¨`insertFromMap`æ–¹æ³•ä¸­ï¼Œè½‰æ›ç‚ºSQLiteæ ¼å¼æ™‚åªå„²å­˜äº†åŸºæœ¬æ¬„ä½ï¼š
```dart
final Map<String, dynamic> row = {
  'id': competitionData['id'],
  'name': competitionData['name'],
  'description': competitionData['description'],
  'venue': competitionData['venue'] ?? '',
  'start_date': competitionData['startDate'],
  'end_date': competitionData['endDate'],
  'status': competitionData['status'],
  'created_by': competitionData['createdBy'],
  'created_at': competitionData['createdAt'],
};
```
eventså’Œmetadataæ¬„ä½æ²’æœ‰è¢«å„²å­˜ã€‚

### 4. ä¾è³´Firebaseä½œç‚ºä¸»è¦æ•¸æ“šä¾†æº
ä»£ç¢¼æ¶æ§‹é¡¯ç¤ºç³»çµ±å„ªå…ˆå¾FirebaseåŠ è¼‰æ•¸æ“šï¼ŒSQLiteä½œç‚ºå‚™ç”¨ï¼š
```dart
try {
  // åŠ è¼‰Firebaseæ•¸æ“š
  final competitionDocs = await competitionsRef.get();
  _competitions = [];
  // ...è™•ç†Firebaseæ•¸æ“š...
} catch (e) {
  // å¦‚æœFirebaseåŠ è¼‰å¤±æ•—ï¼Œå˜—è©¦å¾SQLiteåŠ è¼‰
  // ...
}
```
å¦‚æœFirebaseé€£æ¥æ­£å¸¸ï¼Œç³»çµ±å¯èƒ½æ ¹æœ¬ä¸æœƒä½¿ç”¨SQLiteä¸­çš„æ•¸æ“šã€‚

## è§£æ±ºæ–¹æ¡ˆ

1. **æ›´æ–°SQLiteè¡¨çµæ§‹**ï¼šä¿®æ”¹SQLiteè¡¨ä»¥åŒ…å«ç”¨æ–¼å„²å­˜eventså’Œmetadataçš„JSONæ¬„ä½ï¼š
   ```dart
   await db.execute('''
     CREATE TABLE IF NOT EXISTS $tableCompetitions (
       id TEXT PRIMARY KEY,
       name TEXT NOT NULL,
       description TEXT NOT NULL,
       venue TEXT,
       start_date TEXT NOT NULL,
       end_date TEXT NOT NULL,
       status TEXT NOT NULL,
       created_by TEXT NOT NULL,
       created_at TEXT NOT NULL,
       events TEXT,
       metadata TEXT
     )
   ''');
   ```

2. **æ”¹é€²æ•¸æ“šè½‰æ›**ï¼šåœ¨ä¿å­˜å’Œè®€å–æ•¸æ“šæ™‚ï¼Œå°‡JSONå°è±¡è½‰æ›ç‚ºå­—ç¬¦ä¸²ï¼š
   ```dart
   // ä¿å­˜æ™‚
   final Map<String, dynamic> row = {
     // ...ç¾æœ‰æ¬„ä½...
     'events': jsonEncode(competitionData['events'] ?? []),
     'metadata': jsonEncode(competitionData['metadata'] ?? {}),
   };
   
   // è®€å–æ™‚
   final modelData = {
     // ...ç¾æœ‰æ¬„ä½...
     'events': jsonDecode(maps[i]['events'] ?? '[]'),
     'metadata': jsonDecode(maps[i]['metadata'] ?? '{}'),
   };
   ```

3. **ç¢ºä¿æ­£ç¢ºä½¿ç”¨é»˜èªå€¼**ï¼šæª¢æŸ¥å¹´é½¡åˆ†çµ„è™•ç†ç¨‹åºï¼Œç¢ºä¿åªæœ‰åœ¨çœŸæ­£æ²’æœ‰æ•¸æ“šæ™‚æ‰ä½¿ç”¨é»˜èªå€¼ï¼š
   ```dart
   static List<Map<String, dynamic>> loadAgeGroupsFromMetadata(
       Map<String, dynamic>? metadata) {
     // ...ç¾æœ‰ä»£ç¢¼...
     
     // åªæœ‰åœ¨æ²’æœ‰æ•¸æ“šæ™‚æ‰ä½¿ç”¨é»˜èªå€¼
     if (ageGroups.isEmpty && (metadata == null || !metadata.containsKey('age_groups'))) {
       ageGroups = getDefaultAgeGroups();
     }
     
     return ageGroups;
   }
   ```

4. **å¢å¼·æ—¥èªŒè¨˜éŒ„å’Œé™¤éŒ¯**ï¼šåœ¨é—œéµæ•¸æ“šè™•ç†é»æ·»åŠ æ—¥èªŒï¼Œä»¥ä¾¿æ›´å®¹æ˜“è­˜åˆ¥å•é¡Œï¼š
   ```dart
   _log.info('ğŸ“ è§£æçš„å¹´é½¡åˆ†çµ„: $ageGroups');
   _log.info('ğŸ“ è§£æçš„æ¯”è³½é …ç›®: $events');
   ```

5. **ç¢ºä¿æ•¸æ“šä¸€è‡´æ€§**ï¼šåœ¨ç”¨æˆ¶ç•Œé¢ä¸­æ˜ç¢ºé¡¯ç¤ºæ•¸æ“šä¾†æºï¼Œä»¥ä¾¿ç”¨æˆ¶çŸ¥é“ä»–å€‘çœ‹åˆ°çš„æ˜¯ä¾†è‡ªFirebaseé‚„æ˜¯æœ¬åœ°SQLiteï¼š
   ```dart
   Text('æ•¸æ“šä¾†æº: ${_isOfflineMode ? "æœ¬åœ°å­˜å„²" : "é›²ç«¯"}')
   ```

é€™äº›æ”¹é€²å°‡å¹«åŠ©ç¢ºä¿æ¯”è³½é …ç›®å’Œå¹´é½¡è¨­å®šèƒ½è¢«æ­£ç¢ºå„²å­˜å’Œæ¢å¾©ï¼Œç„¡è«–ç³»çµ±æ˜¯ä½¿ç”¨Firebaseé‚„æ˜¯æœ¬åœ°SQLiteã€‚ 