# Flutteré‹å‹•è³½äº‹ç®¡ç†æ‡‰ç”¨ - è³‡æ–™å„²å­˜å•é¡Œè§£æ±ºæ–¹æ¡ˆ

## å•é¡Œæ¦‚è¿°
ä½¿ç”¨è€…åæ˜ æ¯”è³½å¾Œçš„é …ç›®å’Œå¹´é½¡è¨­å®šç„¡æ³•æ­£ç¢ºå„²å­˜ï¼Œç³»çµ±ç¸½æ˜¯ä½¿ç”¨é è¨­å€¼è€Œéç”¨æˆ¶è¨­å®šçš„å€¼ã€‚é€™å€‹å•é¡Œå°è‡´ä½¿ç”¨è€…ç„¡æ³•è‡ªå®šç¾©æ¯”è³½çš„é‡è¦å±¬æ€§ï¼Œåš´é‡å½±éŸ¿äº†æ‡‰ç”¨çš„ä½¿ç”¨é«”é©—ã€‚

## å•é¡Œåˆ†æ
ç¶“éå…¨é¢æª¢æŸ¥ä»£ç¢¼å’Œæ•¸æ“šçµæ§‹ï¼Œæˆ‘å€‘ç™¼ç¾äº†ä»¥ä¸‹é—œéµå•é¡Œï¼š

1. **SQLiteè¡¨çµæ§‹ä¸å®Œæ•´**ï¼šSQLiteæ•¸æ“šè¡¨`competitions`ç¼ºå°‘å„²å­˜`events`å’Œ`metadata`æ¬„ä½ï¼Œé€™å…©å€‹æ¬„ä½åˆ†åˆ¥ç”¨æ–¼å„²å­˜æ¯”è³½é …ç›®å’Œå¹´é½¡åˆ†çµ„ç­‰é—œéµä¿¡æ¯ã€‚

2. **æ•¸æ“šè½‰æ›æ©Ÿåˆ¶ä¸å®Œå–„**ï¼šç•¶å¾Firebaseè®€å–æ•¸æ“šå’Œå¯«å…¥SQLiteæ™‚ï¼Œè¤‡é›œçš„åµŒå¥—çµæ§‹ï¼ˆå¦‚eventså’Œmetadataï¼‰æ²’æœ‰è¢«æ­£ç¢ºè½‰æ›å’Œå„²å­˜ã€‚

3. **é è¨­å€¼é‚è¼¯å•é¡Œ**ï¼š`AgeGroupHandler`é¡åœ¨è™•ç†å¹´é½¡åˆ†çµ„æ™‚æ²’æœ‰æ­£ç¢ºæª¢æŸ¥è³‡æ–™æ˜¯å¦çœŸçš„ä¸å­˜åœ¨ï¼Œå°è‡´å³ä½¿ç”¨æˆ¶è¨­ç½®äº†è‡ªå®šç¾©å€¼ï¼Œç³»çµ±ä»ç„¶ä½¿ç”¨é è¨­å€¼ã€‚

4. **è³‡æ–™åº«çµæ§‹ç„¡æ³•å‹•æ…‹æ›´æ–°**ï¼šç¼ºå°‘æ©Ÿåˆ¶ä¾†å‡ç´šç¾æœ‰çš„SQLiteæ•¸æ“šåº«çµæ§‹ï¼Œå°è‡´ç„¡æ³•è¼•é¬†æ·»åŠ æ–°æ¬„ä½ã€‚

## è§£æ±ºæ–¹æ¡ˆå¯¦æ–½

### 1. æ›´æ–°SQLiteè¡¨çµæ§‹
ä¿®æ”¹äº†`CompetitionManager`å’Œ`DatabaseHelper`çš„`_onCreate`æ–¹æ³•ï¼Œåœ¨è¡¨çµæ§‹ä¸­åŠ å…¥äº†é—œéµæ¬„ä½ï¼š
```sql
CREATE TABLE IF NOT EXISTS competitions (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT NOT NULL,
  venue TEXT,
  start_date TEXT NOT NULL,
  end_date TEXT NOT NULL,
  status TEXT NOT NULL,
  created_by TEXT NOT NULL,
  created_by_uid TEXT,
  created_at TEXT NOT NULL,
  events TEXT,
  metadata TEXT
)
```

### 2. å®Œå–„æ•¸æ“šè½‰æ›æ©Ÿåˆ¶
å¯¦ç¾äº†JSONåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œæ­£ç¢ºè™•ç†è¤‡é›œçš„åµŒå¥—æ•¸æ“šçµæ§‹ï¼š

- **å¯«å…¥æ™‚**ï¼šåœ¨`insertFromMap`æ–¹æ³•ä¸­å°‡`events`å’Œ`metadata`è½‰æ›ç‚ºJSONå­—ç¬¦ä¸²
  ```dart
  if (competitionData['events'] != null) {
    row['events'] = jsonEncode(competitionData['events']);
  }
  if (competitionData['metadata'] != null) {
    row['metadata'] = jsonEncode(competitionData['metadata']);
  }
  ```

- **è®€å–æ™‚**ï¼šåœ¨`getAllCompetitions`å’Œ`getCompetitionById`æ–¹æ³•ä¸­å°‡JSONå­—ç¬¦ä¸²è½‰æ›å›å°è±¡
  ```dart
  if (maps[i]['events'] != null) {
    modelData['events'] = jsonDecode(maps[i]['events']);
  }
  if (maps[i]['metadata'] != null) {
    modelData['metadata'] = jsonDecode(maps[i]['metadata']);
  }
  ```

### 3. å„ªåŒ–å¹´é½¡åˆ†çµ„è™•ç†é‚è¼¯
ä¿®æ”¹äº†`AgeGroupHandler.loadAgeGroupsFromMetadata`æ–¹æ³•ï¼Œç¢ºä¿åªæœ‰åœ¨ç¢ºå¯¦æ²’æœ‰æ•¸æ“šæ™‚æ‰ä½¿ç”¨é»˜èªå€¼ï¼š
```dart
bool hasFoundData = false;
// æª¢æŸ¥å…©ç¨®å¯èƒ½çš„éµå
if (metadata['age_groups'] != null) {
  hasFoundData = true;
  // è™•ç†é‚è¼¯...
}
else if (metadata['ageGroups'] != null) {
  hasFoundData = true;
  // è™•ç†é‚è¼¯...
}

// åªæœ‰åœ¨æ²’æœ‰æ‰¾åˆ°æ•¸æ“šæ™‚æ‰ä½¿ç”¨é»˜èªå€¼
if (ageGroups.isEmpty && !hasFoundData) {
  ageGroups = getDefaultAgeGroups();
}
```

### 4. å¯¦ç¾æ•¸æ“šåº«å‹•æ…‹å‡ç´šæ©Ÿåˆ¶
æ–°å¢äº†`upgradeDatabase`æ–¹æ³•ï¼Œå…è¨±æ‡‰ç”¨åœ¨é‹è¡Œæ™‚æª¢æŸ¥ä¸¦è‡ªå‹•æ›´æ–°æ•¸æ“šåº«çµæ§‹ï¼š
```dart
Future<void> upgradeDatabase() async {
  // æª¢æŸ¥è¡¨çµæ§‹
  final tableInfo = await db.rawQuery("PRAGMA table_info($tableCompetition)");
  bool hasEventsColumn = false;
  bool hasMetadataColumn = false;
  
  // æª¢æŸ¥æ¬„ä½æ˜¯å¦å­˜åœ¨
  for (var column in tableInfo) {
    if (column['name'] == 'events') hasEventsColumn = true;
    if (column['name'] == 'metadata') hasMetadataColumn = true;
  }
  
  // æ·»åŠ ç¼ºå°‘çš„åˆ—
  if (!hasEventsColumn) {
    await db.execute("ALTER TABLE $tableCompetition ADD COLUMN events TEXT");
  }
  if (!hasMetadataColumn) {
    await db.execute("ALTER TABLE $tableCompetition ADD COLUMN metadata TEXT");
  }
}
```

### 5. å¢å¼·æ—¥èªŒè¨˜éŒ„
åœ¨é—œéµæ•¸æ“šè™•ç†é»æ·»åŠ äº†è©³ç´°çš„æ—¥èªŒè¨˜éŒ„ï¼Œæœ‰åŠ©æ–¼å•é¡Œè¨ºæ–·å’Œæœªä¾†çš„ç¶­è­·ï¼š
```dart
_log.info('ğŸ“ è§£æevents JSONæˆåŠŸ: ${modelData['events']}');
_log.info('ğŸ“Š ç•¶å‰çµæ§‹: eventsæ¬„ä½=${hasEventsColumn}, metadataæ¬„ä½=${hasMetadataColumn}');
_log.info('âœ… å·²æ·»åŠ metadataæ¬„ä½');
```

## ä½¿ç”¨è€…æ›´æ–°æŒ‡å—
ç‚ºäº†å”åŠ©ä½¿ç”¨è€…æ›´æ–°ç¾æœ‰æ‡‰ç”¨ï¼Œæˆ‘å€‘æä¾›äº†å…©ç¨®æ–¹æ³•ï¼š

1. **æ¸…é™¤æ‡‰ç”¨æ•¸æ“šé‡æ–°é–‹å§‹**ï¼ˆç°¡å–®ä½†æœƒä¸Ÿå¤±æœ¬åœ°æ•¸æ“šï¼‰
   - å‚™ä»½é‡è¦æ•¸æ“š
   - æ¸…é™¤æ‡‰ç”¨æ•¸æ“š
   - é‡æ–°å•Ÿå‹•æ‡‰ç”¨

2. **ä½¿ç”¨æ‡‰ç”¨å…§è‡ªå‹•å‡ç´šæ©Ÿåˆ¶**ï¼ˆä¿ç•™ç¾æœ‰æ•¸æ“šï¼‰
   - æ‡‰ç”¨å•Ÿå‹•æ™‚æœƒè‡ªå‹•æª¢æ¸¬ä¸¦å‡ç´šæ•¸æ“šåº«çµæ§‹
   - ç„¡éœ€ç”¨æˆ¶ä»‹å…¥

## é©—è­‰èˆ‡æ¸¬è©¦
æ›´æ–°å¾Œï¼Œæˆ‘å€‘é€²è¡Œäº†ä»¥ä¸‹æ¸¬è©¦ä¾†é©—è­‰è§£æ±ºæ–¹æ¡ˆçš„æœ‰æ•ˆæ€§ï¼š

1. **å‰µå»ºæ–°æ¯”è³½**ï¼šè¨­ç½®è‡ªå®šç¾©é …ç›®å’Œå¹´é½¡åˆ†çµ„
2. **æ‡‰ç”¨é‡å•Ÿæ¸¬è©¦**ï¼šé—œé–‰ä¸¦é‡æ–°æ‰“é–‹æ‡‰ç”¨å¾Œæª¢æŸ¥è³‡æ–™æ˜¯å¦ä¿ç•™
3. **é›¢ç·šæ¨¡å¼æ¸¬è©¦**ï¼šç¢ºä¿åœ¨ç„¡ç¶²çµ¡æƒ…æ³ä¸‹ä¹Ÿèƒ½ä¿å­˜å’Œè®€å–è¨­ç½®
4. **æ•¸æ“šåº«å‡ç´šæ¸¬è©¦**ï¼šé©—è­‰èˆŠç‰ˆæœ¬æ‡‰ç”¨çš„æ•¸æ“šåº«èƒ½é †åˆ©å‡ç´š

æ‰€æœ‰æ¸¬è©¦å‡è¡¨æ˜è§£æ±ºæ–¹æ¡ˆæœ‰æ•ˆè§£æ±ºäº†å•é¡Œã€‚

## æŠ€è¡“ç¶“é©—èˆ‡å»ºè­°

### ç¶“é©—ç¸½çµ
1. **JSONåºåˆ—åŒ–é‡è¦æ€§**ï¼šå°æ–¼SQLiteï¼Œä½¿ç”¨JSONåºåˆ—åŒ–æ˜¯è™•ç†è¤‡é›œåµŒå¥—æ•¸æ“šçµæ§‹çš„æœ‰æ•ˆæ–¹æ³•
2. **é è¨­å€¼è¬¹æ…ä½¿ç”¨**ï¼šé è¨­å€¼æ‡‰åªåœ¨ç¢ºèªè³‡æ–™ä¸å­˜åœ¨æ™‚ä½¿ç”¨ï¼Œä¸¦éœ€è©³ç´°æ—¥èªŒ
3. **æ•¸æ“šåº«ç‰ˆæœ¬ç®¡ç†**ï¼šæ‡‰ç”¨æ‡‰å…·å‚™æ•¸æ“šåº«è‡ªå‹•å‡ç´šæ©Ÿåˆ¶ä»¥é©æ‡‰æœªä¾†çš„çµæ§‹è®Šæ›´

### æœªä¾†å»ºè­°
1. **å¯¦ç¾å®Œæ•´çš„æ•¸æ“šåº«ç‰ˆæœ¬ç®¡ç†**ï¼šåœ¨`onUpgrade`å›èª¿ä¸­è™•ç†ä¸åŒç‰ˆæœ¬é–“çš„é·ç§»
2. **æ•¸æ“šåŒæ­¥æ©Ÿåˆ¶æ”¹é€²**ï¼šå„ªåŒ–Firebaseå’ŒSQLiteé–“çš„åŒæ­¥ç­–ç•¥ï¼Œè€ƒæ…®ä½¿ç”¨æ™‚é–“æˆ³æˆ–ç‰ˆæœ¬è™Ÿ
3. **æ·»åŠ æ•¸æ“šå®Œæ•´æ€§æª¢æŸ¥**ï¼šåœ¨è®€å¯«æ•¸æ“šæ™‚å¢åŠ å®Œæ•´æ€§æª¢æŸ¥ä»¥é˜²æ­¢æ•¸æ“šæå£
4. **æ”¹é€²UIåé¥‹**ï¼šåœ¨æ‡‰ç”¨ä¸­é¡¯ç¤ºæ•¸æ“šä¾†æºï¼ˆæœ¬åœ°/é›²ç«¯ï¼‰ä»¥æé«˜é€æ˜åº¦

## çµè«–
é€šéæ·±å…¥åˆ†æå’Œæœ‰é‡å°æ€§çš„ä¿®æ”¹ï¼Œæˆ‘å€‘æˆåŠŸè§£æ±ºäº†æ¯”è³½é …ç›®å’Œå¹´é½¡è¨­å®šç„¡æ³•æ­£ç¢ºå„²å­˜çš„å•é¡Œã€‚é€™äº›æ”¹é€²ä¸åƒ…ä¿®å¾©äº†ç•¶å‰å•é¡Œï¼Œé‚„å¢å¼·äº†æ‡‰ç”¨çš„ç©©å®šæ€§å’Œå¯ç¶­è­·æ€§ã€‚è³‡æ–™åº«å‹•æ…‹å‡ç´šæ©Ÿåˆ¶çš„å¯¦ç¾ä¹Ÿç‚ºæœªä¾†çš„åŠŸèƒ½æ“´å±•æä¾›äº†è‰¯å¥½çš„åŸºç¤ã€‚ 