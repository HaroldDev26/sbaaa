# Flutteré‹å‹•è³½äº‹ç®¡ç†æ‡‰ç”¨ - è³‡æ–™å„²å­˜å•é¡Œä¿®å¾©æ–¹æ¡ˆ

## å•é¡ŒèƒŒæ™¯
ä½¿ç”¨è€…åœ¨ä½¿ç”¨æ‡‰ç”¨ç¨‹å¼æ™‚ï¼Œç™¼ç¾æ¯”è³½çš„é …ç›®å’Œå¹´é½¡è¨­å®šç„¡æ³•æ­£ç¢ºå„²å­˜ï¼Œç³»çµ±ç¸½æ˜¯ä½¿ç”¨é è¨­å€¼è€Œéç”¨æˆ¶è¨­å®šçš„å€¼ã€‚

## å•é¡Œè¨ºæ–·
ç¶“éä»£ç¢¼åˆ†æï¼Œæˆ‘å€‘ç™¼ç¾äº†ä»¥ä¸‹å•é¡Œï¼š

1. **SQLiteè¡¨çµæ§‹ç¼ºå°‘é—œéµæ¬„ä½**ï¼šè³‡æ–™åº«è¡¨ä¸­æ²’æœ‰ç”¨æ–¼å„²å­˜eventså’Œmetadataçš„æ¬„ä½ï¼Œå°è‡´é€™äº›è³‡æ–™ç„¡æ³•æŒä¹…åŒ–ã€‚
2. **è³‡æ–™è½‰æ›ä¸å®Œæ•´**ï¼šå¾SQLiteè®€å–è³‡æ–™æ™‚ï¼Œä¸¦æœªåŒ…å«eventså’Œmetadataæ¬„ä½çš„è½‰æ›ã€‚
3. **é»˜èªå€¼é‚è¼¯å•é¡Œ**ï¼šå¹´é½¡åˆ†çµ„è™•ç†ç¨‹åºç¸½æ˜¯åœ¨æ²’æœ‰æ‰¾åˆ°è³‡æ–™æ™‚ä½¿ç”¨é»˜èªå€¼ï¼Œä½†æœªæ­£ç¢ºæª¢æŸ¥è³‡æ–™æ˜¯å¦çœŸçš„ä¸å­˜åœ¨ã€‚
4. **ç¼ºä¹æ—¥èªŒè¨˜éŒ„**ï¼šé—œéµè³‡æ–™è™•ç†é»ç¼ºå°‘è©³ç´°æ—¥èªŒï¼Œä½¿å•é¡Œé›£ä»¥è¨ºæ–·ã€‚

## ä¿®å¾©æªæ–½

### 1. æ›´æ–°SQLiteè¡¨çµæ§‹
æˆ‘å€‘ä¿®æ”¹äº†`CompetitionManager`å’Œ`DatabaseHelper`é¡çš„`_onCreate`æ–¹æ³•ï¼ŒåŠ å…¥äº†eventså’Œmetadataæ¬„ä½ï¼š
```sql
CREATE TABLE IF NOT EXISTS competitions (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT NOT NULL,
  venue TEXT,
  start_date TEXT NOT NULL,
  end_date TEXT NOT NULL,
  status TEXT NOT NULL,
  created_by TEXT NOT NULL,
  created_by_uid TEXT,
  created_at TEXT NOT NULL,
  events TEXT,
  metadata TEXT
)
```

### 2. æ”¹é€²è³‡æ–™å„²å­˜æ©Ÿåˆ¶
åœ¨`insertFromMap`æ–¹æ³•ä¸­ï¼Œæˆ‘å€‘æ–°å¢äº†è™•ç†eventså’Œmetadataçš„ä»£ç¢¼ï¼Œå°‡é€™äº›è¤‡é›œæ•¸æ“šçµæ§‹è½‰æ›ç‚ºJSONå­—ç¬¦ä¸²å¾Œå„²å­˜ï¼š
```dart
// å°‡eventså’Œmetadataè½‰æ›ç‚ºJSONå­—ç¬¦ä¸²
if (competitionData['events'] != null) {
  row['events'] = jsonEncode(competitionData['events']);
  _log.info('ğŸ“ è½‰æ›eventsç‚ºJSON: ${row['events']}');
}

if (competitionData['metadata'] != null) {
  row['metadata'] = jsonEncode(competitionData['metadata']);
  _log.info('ğŸ“ è½‰æ›metadataç‚ºJSON: ${row['metadata']}');
}
```

### 3. å®Œå–„è³‡æ–™è®€å–é‚è¼¯
åœ¨`getAllCompetitions`å’Œ`getCompetitionById`æ–¹æ³•ä¸­ï¼ŒåŠ å…¥äº†è™•ç†JSONæ ¼å¼eventså’Œmetadataçš„ä»£ç¢¼ï¼š
```dart
// è™•ç†JSONæ ¼å¼çš„eventså’Œmetadata
if (maps[i]['events'] != null) {
  try {
    modelData['events'] = jsonDecode(maps[i]['events']);
    _log.info('ğŸ“ è§£æevents JSONæˆåŠŸ: ${modelData['events']}');
  } catch (jsonError) {
    _log.warning('âš ï¸ è§£æevents JSONå¤±æ•—: $jsonError');
  }
}

if (maps[i]['metadata'] != null) {
  try {
    modelData['metadata'] = jsonDecode(maps[i]['metadata']);
    _log.info('ğŸ“ è§£æmetadata JSONæˆåŠŸ: ${modelData['metadata']}');
    
    // ç‰¹åˆ¥æª¢æŸ¥å¹´é½¡çµ„åˆ¥
    if (modelData['metadata']['age_groups'] != null) {
      _log.info('ğŸ“ ç™¼ç¾å¹´é½¡çµ„åˆ¥æ•¸æ“š: ${modelData['metadata']['age_groups']}');
    }
  } catch (jsonError) {
    _log.warning('âš ï¸ è§£æmetadata JSONå¤±æ•—: $jsonError');
  }
}
```

### 4. å„ªåŒ–å¹´é½¡åˆ†çµ„è™•ç†
ä¿®æ”¹äº†`AgeGroupHandler.loadAgeGroupsFromMetadata`æ–¹æ³•ï¼Œç¢ºä¿åªæœ‰åœ¨ç¢ºå¯¦æ²’æœ‰æ•¸æ“šæ™‚æ‰ä½¿ç”¨é»˜èªå€¼ï¼š
```dart
// æ·»åŠ æ¨™èªŒè·Ÿè¸ªæ˜¯å¦æ‰¾åˆ°æ•¸æ“š
bool hasFoundData = false;

// æª¢æŸ¥å…©ç¨®å¯èƒ½çš„éµåï¼šage_groupså’ŒageGroups
if (metadata['age_groups'] != null) {
  hasFoundData = true;
  // è™•ç†é‚è¼¯...
}
else if (metadata['ageGroups'] != null) {
  hasFoundData = true;
  // è™•ç†é‚è¼¯...
}

// åªæœ‰åœ¨ç¢ºå¯¦æ²’æœ‰æ‰¾åˆ°æ•¸æ“šæ™‚æ‰ä½¿ç”¨é»˜èªå€¼
if (ageGroups.isEmpty && !hasFoundData) {
  ageGroups = getDefaultAgeGroups();
}
```

### 5. å¢å¼·æ—¥èªŒè¨˜éŒ„
åœ¨é—œéµæ•¸æ“šè™•ç†é»æ·»åŠ äº†è©³ç´°çš„æ—¥èªŒè¨˜éŒ„ï¼Œæœ‰åŠ©æ–¼å•é¡Œè¨ºæ–·ï¼š
```dart
_log.info('âœ… å·²æˆåŠŸè§£æå¹´é½¡çµ„åˆ¥: $ageGroups');
_log.info('ğŸ“ è§£æmetadata JSONæˆåŠŸ: ${modelData['metadata']}');
_log.info('ğŸ“ ç™¼ç¾å¹´é½¡çµ„åˆ¥æ•¸æ“š: ${modelData['metadata']['age_groups']}');
```

## é æœŸæ•ˆæœ
å®Œæˆä»¥ä¸Šä¿®æ”¹å¾Œï¼Œç³»çµ±å°‡èƒ½å¤ ï¼š
1. æ­£ç¢ºå„²å­˜æ¯”è³½çš„é …ç›®å’Œå¹´é½¡è¨­å®š
2. å¾SQLiteæ•¸æ“šåº«ä¸­æ¢å¾©å®Œæ•´çš„æ¯”è³½è³‡æ–™
3. åªåœ¨çœŸæ­£æ²’æœ‰è¨­å®šè³‡æ–™æ™‚æ‰ä½¿ç”¨é»˜èªå€¼
4. é€šéè©³ç´°æ—¥èªŒå”åŠ©é–‹ç™¼è€…è¨ºæ–·å•é¡Œ

ç”¨æˆ¶ç¾åœ¨æ‡‰è©²èƒ½å¤ çœ‹åˆ°ä»–å€‘è¨­ç½®çš„æ¯”è³½é …ç›®å’Œå¹´é½¡åˆ†çµ„è¢«æ­£ç¢ºä¿å­˜å’Œé¡¯ç¤ºï¼Œè€Œä¸æ˜¯ç¸½æ˜¯ä½¿ç”¨ç³»çµ±é»˜èªå€¼ã€‚ 